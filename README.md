# ScanConv - RGBI対応スキャンコンバータ(FPGAデータ)

## はじめに

このドキュメントを含むファイルは、拙作「RGBI対応スキャンコンバータ」に使用したFPGAをコンフィグレーションするために必要なソース及びプロジェクト一式です。

スキャンコンバータの概要やおおまかな動作原理については、次のWebサイトを参照してください。なお予告なくURLが変更されることがありますので、もし行方不明になった時は恐れ入りますがググるなどして捜して下さい。

[RGBI対応アップスキャンコンバータ](http://cwaweb.bai.ne.jp/~ohishi/zakki/ScanConv.htm)


## 開発環境

FPGAはザイリンクスのISE14.2にて開発しました。作成時期的にバージョンが古かったりVivadoとはいかなくてもせめてPlanAheadだろうとかいうご意見もありましょうが、そのあたりは気分の問題というか、最初のバージョンがISE時代に作成された名残ということであまり気にしないで下さい。

ISEを起動し、ファイルを展開したフォルダを開いてScanConv.xiseを指定するとプロジェクトが再生されます。あとはISEの使い方に沿って改造など様々な用途に活用して下さい。


## ソースの簡単な説明

ほとんどコメントのない不親切なソースですが、ここで簡単な説明をしておきます。機能としては

1. RGBI→RGB変換
2. ラインダブラーを含むスキャンコンバート

の二つに大分されます。

RGBI→RGB変換は、176行目から424行目のテーブル変換で行います。switch～caseが複数ブロックありますが、これはスイッチ選択で切り替えられた変換モードごとにテーブルがあるという構成になっています。

スキャンコンバートはckgenというクロック生成モジュール(32MHzクロック入力から64MHzと100MHzを生成)とRAM(4096×4bit)、その他回路で構成されています。RAMはデュアルポートで構成され、ポートAを入力専用、ポートBを出力専用として使っています。

64MHzクロックは入力側のドットクロックの4倍として生成させています。つまり水平同期周波数15kHz・640ドットにおけるドットクロック、16MHzの4倍です。
なおこのドットクロックはMZ-2000用CRTであるMZ-1D01の仕様を元に決定しています。より汎用的には14.318MHzの方が好ましいようですが、今回は実験も比較もしていません。

64MHzクロックでは水平同期信号が入ったら('L')カウンタをリセットします。念のため入力はフィルタリングしてありますが、果たしてどの程度効果があるのかはわかりません…(119行目～133行目)。

カウンタICTRはそのままRAMの入力側アドレスカウンタとして使っています。

100MHzクロックは出力側の水平同期信号生成とRAMの出力側アドレスカウンタとして使っています(137行目～173行目)。

入力側と同様に水平同期信号をフィルタリングしてカウンタCTR100Mをリセットします。このカウンタは2行分カウントするのですが、これは入力側の1ライン分の時間を測るためのものです。中央値をTSに入れて、出力用カウンタのOCTRの上限値として使用しています。OCTRを元に出力用水平同期信号を生成し、RAMの出力用アドレスカウンタとしています。

これは機種によって信号の細かいタイミングが異なることが考えられるため、その値をハードコーディングしておくわけにもいかず、まぁ半分なのだから…とわりと簡単な考え方で作ったものですが、一応表示できてますので、そんなに的外れなものでもなかったようです。

またそのカウンタを元に出力用水平同期信号と水平ブランキング信号を作成しています。水平ブランキング信号はX1シリーズのボーダーカラー出力に対応するもので、これを元に出力用映像信号をマスクすることでモニターの色が暗く変化するのを防いでいます。現時点ではX1turboの標準解像度モードでの現物合わせでそのタイミングを決めているので、今後もし他の機種で不都合があった場合は予告なく変更することがあります。もし左右の端に表示されない部分があったら、166行目(左端)や168行目(右端)の数値を変更してみて下さい。


## 謝辞および参考文献

- [「ELM - スキャンコンバータ」 (ChaN氏)](http://elm-chan.org/works/sc/report_j.html)
- [「～ VGA液晶パネル用スキャンコンバータの製作 ～」 (京谷 豊氏)](http://www.kyotani-hobby.com/scanconv/scanconv1.htm)

いずれもかなり以前からあるアップスキャンコンバータの製作例。ラインダブラーの考え方をここで学びました。といってもこれらの製作例ではラインメモリを使用しているため、FPGAではデュアルポートRAMに置き換える必要があります。

- [「デザインウェーブ マガジン 2007年7月号」 (CQ出版社)](http://www.cqpub.co.jp/dwm/contents/dwm0116i.htm)

使用したFPGA基板が付録としてついてきた雑誌です。今となっては雑誌自体なくなりましたが、回路図など一部データや記事が今でも参照できます。

- [「Spartan-3E FPGA Family Data Sheet」 (Xilinx)](http://japan.xilinx.com/support/documentation/data_sheets/ds312.pdf)

デバイスの仕様はデータシートをよく読んで。以前入手できた日本語版は改版対応してないせいか提供されなくなってしまいました。

なおデジタルRGB出力の同期信号タイミングは当時のカタログ等に掲載されたものを参考にしています。


## 免責事項

本データ全体または一部を利用した結果につきまして、いかなる損害・損失についても当方はその責任を全て免除されるものといたします。
